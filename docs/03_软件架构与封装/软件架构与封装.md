# 3. 软件架构与封装

本章节详细介绍 Aura Alpha 的软件架构设计，帮助开发者理解系统的整体结构和各模块之间的关系。

---

## 🏗️ 系统架构概览

Aura Alpha 采用 **ROS2 Humble** 作为底层通信框架，整体架构分为四层：

```
┌─────────────────────────────────────────────────────────────┐
│                      编排层 (Bringup)                        │
│              robot_bringup - 启动编排与配置管理               │
├─────────────────────────────────────────────────────────────┤
│                      应用层 (Apps)                           │
│   cloud_realtime_node │ display_node │ easter_egg_node      │
├─────────────────────────────────────────────────────────────┤
│                      感知层 (Perception)                     │
│      mono2d_body_detection_node │ body_tracking_node        │
├─────────────────────────────────────────────────────────────┤
│                      驱动层 (Drivers)                        │
│            audio_vm8960_node │ motor_node                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 功能模块说明

### 驱动层 (Drivers)

| 模块 | 语言 | 功能描述 |
|------|------|----------|
| `audio_vm8960_node` | Python | WM8960 音频芯片驱动，支持麦克风采集和扬声器播放 |
| `motor_node` | Python | 串口差速电机驱动，集成 IMU 和电池监控 |

### 感知层 (Perception)

| 模块 | 语言 | 功能描述 |
|------|------|----------|
| `mono2d_body_detection_node` | C++ | 基于 BPU 的人体 2D 检测和关键点识别 |
| `body_tracking_node` | C++ | 人体目标跟踪，生成运动控制指令 |

### 应用层 (Apps)

| 模块 | 语言 | 功能描述 |
|------|------|----------|
| `cloud_realtime_node` | Python | 云端实时语音 AI 交互，支持多家云服务商 |
| `display_node` | Python | 屏幕显示控制，根据 AI 状态切换动画 |
| `easter_egg_node` | Python | 彩蛋功能，支持手势挑战和关键词触发 |

### 编排层 (Bringup)

| 模块 | 功能描述 |
|------|----------|
| `robot_bringup` | 顶层启动编排，管理节点启动顺序和依赖关系 |

---

## 🔄 话题通信架构

### 核心数据流

```
┌──────────────────┐     /audio_data      ┌──────────────────┐
│ audio_vm8960_node│ ──────────────────→  │cloud_realtime_node│
│   (麦克风采集)    │                      │   (语音 AI)       │
└──────────────────┘                      └────────┬─────────┘
        ↑                                          │
        │ /audio_playback                          │ /ai/state
        └──────────────────────────────────────────┤ /ai/emotion
                                                   ↓
┌──────────────────┐     /cmd_vel         ┌──────────────────┐
│    motor_node    │ ←────────────────────│  body_tracking   │
│   (电机控制)      │                      │   (人体跟踪)      │
└──────────────────┘                      └────────┬─────────┘
                                                   ↑
                                                   │ /hobot_mono2d_body_detection
                                          ┌────────┴─────────┐
                                          │mono2d_body_detect│
                                          │   (人体检测)      │
                                          └──────────────────┘
```

### 话题列表总览

| 话题名称 | 消息类型 | 发布者 | 订阅者 | 说明 |
|---------|---------|--------|--------|------|
| `/audio_data` | `UInt8MultiArray` | audio_vm8960_node | cloud_realtime_node | 麦克风原始音频 |
| `/audio_playback` | `UInt8MultiArray` | cloud_realtime_node | audio_vm8960_node | TTS 播放音频 |
| `/cmd_vel` | `Twist` | body_tracking_node | motor_node | 速度控制指令 |
| `/imu/data` | `Imu` | motor_node | - | 陀螺仪数据 |
| `/battery_state` | `BatteryState` | motor_node | - | 电池状态 |
| `/ai/state` | `String` | cloud_realtime_node | display_node | AI 状态 |
| `/ai/emotion` | `String` | cloud_realtime_node | display_node | 情绪状态 |
| `/hobot_mono2d_body_detection` | `PerceptionTargets` | mono2d_body_detection | body_tracking | 人体检测结果 |
| `/display/ready` | `Bool` | display_node | cloud_realtime_node | 显示就绪信号 |
| `/cloud_realtime/ready` | `Bool` | cloud_realtime_node | body_tracking | 语音就绪信号 |

---

## ⚙️ 配置文件结构

### 目录布局

```
workspace/src/
├── bringup/robot_bringup/config/
│   ├── settings.yaml          # 功能开关配置
│   └── log_levels.yaml        # 日志级别配置
├── drivers/
│   ├── audio_vm8960_node/config/
│   │   ├── audio_duplex.yaml  # 双工模式配置
│   │   ├── audio_publisher.yaml
│   │   └── audio_player.yaml
│   └── motor_node/config/
│       └── config.yaml        # 电机参数配置
└── apps/
    ├── cloud_realtime_node/config/
    │   ├── config.yaml        # AI 提供商配置
    │   └── prompts.yaml       # 提示词配置
    ├── display_node/config/
    │   └── display.yaml       # 显示配置
    └── easter_egg_node/config/
        └── config.yaml        # 彩蛋配置
```

### settings.yaml 功能开关

```yaml
settings:
  # 人体跟随开关
  enable_body_following: false
    # true  → body_tracking 发布到 /cmd_vel（机器人会跟随人体移动）
    # false → body_tracking 发布到 /follow_cmd_vel（机器人不响应）

  # 语音交互开关
  enable_voice: false
    # true  → 启动云端实时对话节点
    # false → 跳过语音节点
```

### log_levels.yaml 日志级别

```yaml
log_levels:
  motor_node:             fatal   # 完全静默
  audio_duplex:           fatal
  cloud_realtime:         fatal
  display_node:           fatal
  easter_egg_node:        info    # 显示一般信息
  mono2d_body_detection:  fatal
  body_tracking:          fatal
```

> **日志级别说明**：`debug` > `info` > `warn` > `error` > `fatal`

---

## 🚀 启动流程

### 启动顺序

系统采用分阶段启动，通过话题信号同步各节点：

```
阶段 1: 基础驱动
├── motor_node          # 电机驱动（立即启动）
└── audio_duplex        # 音频驱动（立即启动）

阶段 2: 应用层
├── display_node        # 显示节点（预加载视频）
│   └── 发布 /display/ready
├── cloud_realtime      # 语音节点（等待 /display/ready）
│   └── 发布 /cloud_realtime/ready
└── easter_egg_node     # 彩蛋节点

阶段 3: 感知层
└── body_tracking       # 人体跟踪（等待就绪信号）
    └── 等待 /cloud_realtime/ready 或 /display/ready
```

### 启动命令

```bash
# 进入工作空间
cd /path/to/workspace

# 加载 ROS2 环境
source /opt/tros/humble/setup.bash
source install/setup.bash

# 启动完整系统
ros2 launch robot_bringup bringup.launch.py

# 可选：禁用感知层（无摄像头时）
ros2 launch robot_bringup bringup.launch.py enable_perception:=false
```

---

## 🔧 编译说明

### Python 包

Python 包无需特殊编译，直接使用 colcon 构建：

```bash
colcon build --packages-select audio_vm8960_node motor_node cloud_realtime_node display_node easter_egg_node robot_bringup
```

### C++ 感知包

感知层 C++ 包需要指定目标平台：

```bash
# RDK X5 平台（默认）
colcon build --packages-select mono2d_body_detection body_tracking \
  --cmake-args -DPLATFORM_X5=ON

# 其他平台
# -DPLATFORM_X3=ON      # RDK X3
# -DPLATFORM_Rdkultra=ON # RDK Ultra
# -DPLATFORM_S100=ON    # S100
```

> **⚠️ 注意**：不指定平台参数时默认为 X3，可能导致运行时错误。

---

## 📊 性能指标

| 模块 | 典型延迟 | CPU 占用 | 说明 |
|------|---------|---------|------|
| audio_vm8960_node | < 20ms | < 5% | 音频采集和播放 |
| motor_node | < 10ms | < 3% | 电机控制响应 |
| mono2d_body_detection | 30-50ms | BPU 加速 | 人体检测推理 |
| body_tracking | < 10ms | < 5% | 跟踪算法 |
| cloud_realtime_node | 网络依赖 | < 10% | 云端 AI 交互 |
| display_node | < 16ms | < 15% | 视频渲染 |

